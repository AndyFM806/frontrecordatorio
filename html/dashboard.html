<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel - Recordatorio Bancario</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #ffd4e2 0%, #fff 100%);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      background: #c2185b;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    main {
      margin-top: 40px;
      width: 95%;
      max-width: 1000px;
      background: white;
      border-radius: 16px;
      padding: 30px 40px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    h2 {
      color: #ad1457;
      border-bottom: 2px solid #f8bbd0;
      padding-bottom: 5px;
      margin-top: 30px;
    }

    .prestamo-card {
      background: #fff0f5;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: 0.2s;
    }

    .prestamo-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .prestamo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cuotas-list {
      display: none;
      margin-top: 10px;
      padding-left: 15px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cuota-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f2b5c3;
      padding: 8px 0;
      font-size: 0.95rem;
    }

    .estado {
      font-weight: bold;
    }

    .pendiente {
      color: #e53935;
    }

    .pagada {
      color: #43a047;
    }

    .acciones {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: #c2185b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #ad1457;
      transform: translateY(-2px);
    }

    footer {
      margin-top: auto;
      text-align: center;
      font-size: 13px;
      color: #777;
      padding: 20px 0;
    }

    .alerta {
      background: #ffebee;
      border-left: 5px solid #e53935;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 6px;
      color: #c62828;
    }

    form {
      margin-top: 10px;
      background: #ffe4ec;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    form h3 {
      color: #ad1457;
      margin-bottom: 10px;
    }

    form input {
      display: block;
      margin: 10px 0;
      width: 100%;
      padding: 8px;
      border: 1px solid #f48fb1;
      border-radius: 6px;
    }

    form button {
      margin-top: 10px;
      width: 100%;
    }
            .alerta-flotante {
        background: #ffebee;
        border-left: 5px solid #e53935;
        padding: 8px 12px;
        margin: 10px 0 12px;
        border-radius: 6px;
        color: #b71c1c;
        font-size: 0.9rem;
        font-weight: 500;
        animation: blink 1.3s ease-in-out infinite alternate;
        }

        @keyframes blink {
        from { background-color: #ffebee; }
        to { background-color: #ffcdd2; }
        }

  </style>
</head>
<body>
  <header>Bienvenido al Panel de Control</header>

  <main>
    <div id="alertas"></div>

    <h2>âž• Registrar nuevo prÃ©stamo</h2>
    <form id="formNuevoPrestamo">
      <input type="number" id="monto" placeholder="Monto del prÃ©stamo (S/.)" required />
      <input type="number" id="interes" placeholder="InterÃ©s (%)" required />
      <input type="number" id="cuotas" placeholder="NÃºmero de cuotas" required />
      <label for="fechaEmision"><strong>Fecha de emisiÃ³n:</strong></label>
      <input type="date" id="fechaEmision" required />
      <button type="submit">Registrar prÃ©stamo</button>
    </form>

    <h2>ðŸ‘¤ InformaciÃ³n del Usuario</h2>
    <p><strong>Nombre:</strong> <span id="userNombre">Cargando...</span></p>
    <p><strong>Correo:</strong> <span id="userCorreo">Cargando...</span></p>

    <h2>ðŸ’° Tus PrÃ©stamos y Cuotas</h2>
    <div id="prestamosContainer">
      <p>Cargando tus prÃ©stamos...</p>
    </div>

    <div class="acciones">
      <button id="btnEnviarCorreo">ðŸ“© Enviar correo de prueba</button>
      <button id="btnLogout">ðŸšª Cerrar sesiÃ³n</button>
    </div>
  </main>

  <footer>Â© 2025 Recordatorio Bancario</footer>

  <script>
document.addEventListener("DOMContentLoaded", async () => {
  const API_URL = "https://demo-pmeu.onrender.com";
  const userData = JSON.parse(localStorage.getItem("usuario"));
  const prestamosContainer = document.getElementById("prestamosContainer");

  if (!userData) {
    window.location.href = "index.html";
    return;
  }

  document.getElementById("userNombre").textContent = userData.nombre;
  document.getElementById("userCorreo").textContent = userData.email;

  // ðŸ”¹ FunciÃ³n: normalizar fecha (sin horas)
  const normalizarFecha = (fecha) =>
    new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());

  // ðŸ”¹ Cargar prÃ©stamos y mostrar alertas individuales
  async function cargarPrestamos() {
    try {
      const res = await fetch(`${API_URL}/prestamos/usuario/${userData.id}`);
      const prestamos = await res.json();
      prestamosContainer.innerHTML = "";

      if (!prestamos.length) {
        prestamosContainer.innerHTML = `<p>No tienes prÃ©stamos registrados.</p>`;
        return;
      }

      prestamos.forEach((p) => {
        const card = document.createElement("div");
        card.classList.add("prestamo-card");

        // ðŸ“… Buscar cuotas prÃ³ximas a vencer (<= 2 dÃ­as)
        const hoy = normalizarFecha(new Date());
        const proximas = [];

        p.cuotas.forEach((c) => {
          if (c.estado !== "PENDIENTE") return;
          const fechaV = new Date(c.fechaVencimiento);
          const fechaNormalizada = normalizarFecha(fechaV);
          const diffDias =
            (fechaNormalizada - hoy) / (1000 * 60 * 60 * 24);
          if (diffDias <= 2 && diffDias >= 0) proximas.push(c);
        });

        // ðŸ§© HTML del prÃ©stamo
        card.innerHTML = `
          <div class="prestamo-header">
            <h3>PrÃ©stamo #${p.id}</h3>
            <span><strong>Monto:</strong> S/.${p.monto.toFixed(2)}</span>
          </div>
          <p><strong>InterÃ©s:</strong> ${p.interes}% | <strong>Emitido:</strong> ${p.fechaEmision}</p>

          ${
            proximas.length > 0
              ? `<div class="alerta-flotante">
                  âš ï¸ Tienes ${
                    proximas.length === 1 ? "una deuda" : "varias deudas"
                  } que vencen ${
                    proximas.length === 1
                      ? "el " + proximas[0].fechaVencimiento
                      : "en las fechas: " +
                        proximas.map((c) => c.fechaVencimiento).join(", ")
                  }.
                </div>`
              : ""
          }

          <div class="cuotas-list">
  ${p.cuotas
    .map(
      (c) => `
      <div class="cuota-item">
        <span>Cuota ${c.numero}</span>
        <span>ðŸ’° S/.${c.monto.toFixed(2)}</span>
        <span>ðŸ“… Vence: ${c.fechaVencimiento}</span>
        <span class="estado ${c.estado.toLowerCase()}">${c.estado}</span>
        ${
          c.estado === "PENDIENTE"
            ? `<button class="btnPagar" data-id="${c.id}">Pagar</button>`
            : ""
        }
      </div>`
    ).join("")}
</div>

              )
              .join("")}
          </div>
        `;

        // ðŸŽ¯ Toggle de cuotas
        const cuotasDiv = card.querySelector(".cuotas-list");
        card.addEventListener("click", (e) => {
          if (!e.target.classList.contains("btnPagar")) {
            cuotasDiv.style.display =
              cuotasDiv.style.display === "block" ? "none" : "block";
          }
        });

        prestamosContainer.appendChild(card);
      });

      // ðŸŽ¯ Listeners para pagar
      document.querySelectorAll(".btnPagar").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const cuotaId = btn.getAttribute("data-id");
          await fetch(`${API_URL}/cuotas/${cuotaId}/pagar`, { method: "PUT" });
          alert("âœ… Cuota marcada como pagada");
          cargarPrestamos();
        });
      });
    } catch (err) {
      prestamosContainer.innerHTML =
        "<p style='color:red;'>Error al cargar prÃ©stamos.</p>";
      console.error(err);
    }
  }

  cargarPrestamos();

  // ðŸ”¹ Registrar nuevo prÃ©stamo
  document.getElementById("formNuevoPrestamo").addEventListener("submit", async (e) => {
    e.preventDefault();
    const monto = document.getElementById("monto").value;
    const interes = document.getElementById("interes").value;
    const numeroCuotas = document.getElementById("cuotas").value;
    const fechaEmision = document.getElementById("fechaEmision").value;

    if (!fechaEmision) {
      alert("âš ï¸ Debes seleccionar una fecha de emisiÃ³n vÃ¡lida");
      return;
    }

    await fetch(`${API_URL}/prestamos/crear?usuarioId=${userData.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ monto, interes, numeroCuotas, fechaEmision }),
    });

    alert("âœ… PrÃ©stamo registrado con Ã©xito");
    e.target.reset();
    cargarPrestamos();
  });

  // ðŸ”¹ Enviar correo
  // ðŸ”¹ Enviar correos de prueba (cuotas prÃ³ximas a vencer)
document.getElementById("btnEnviarCorreo").addEventListener("click", async () => {
  const btn = document.getElementById("btnEnviarCorreo");
  btn.disabled = true;
  btn.textContent = "Enviando correos... â³";

  try {
    const res = await fetch(`${API_URL}/email/test/usuario/${userData.id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: "{}"
    });

    if (!res.ok) throw new Error("Error al comunicarse con el servidor");

    const mensaje = await res.text();

    // Mostrar notificaciÃ³n contextual
    
      alert("âœ… " + mensaje);

  } catch (err) {
    console.error(err);
    alert("âŒ Error al intentar enviar los correos de prueba.");
  } finally {
    btn.disabled = false;
    btn.textContent = "ðŸ“§ Enviar correos de prueba";
  }
});


  // ðŸ”¹ Logout
  document.getElementById("btnLogout").addEventListener("click", () => {
    localStorage.removeItem("usuario");
    window.location.href = "index.html";
  });
});
</script>

</body>
</html>
