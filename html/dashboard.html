<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel - Recordatorio Bancario</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #ffd4e2 0%, #fff 100%);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      background: #c2185b;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    main {
      margin-top: 40px;
      width: 95%;
      max-width: 1000px;
      background: white;
      border-radius: 16px;
      padding: 30px 40px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    h2 {
      color: #ad1457;
      border-bottom: 2px solid #f8bbd0;
      padding-bottom: 5px;
      margin-top: 30px;
    }

    .prestamo-card {
      background: #fff0f5;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: 0.2s;
    }

    .prestamo-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .prestamo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cuotas-list {
      display: none;
      margin-top: 10px;
      padding-left: 15px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cuota-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f2b5c3;
      padding: 8px 0;
      font-size: 0.95rem;
    }

    .estado {
      font-weight: bold;
    }

    .pendiente {
      color: #e53935;
    }

    .pagada {
      color: #43a047;
    }

    .acciones {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: #c2185b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #ad1457;
      transform: translateY(-2px);
    }

    footer {
      margin-top: auto;
      text-align: center;
      font-size: 13px;
      color: #777;
      padding: 20px 0;
    }

    .alerta {
      background: #ffebee;
      border-left: 5px solid #e53935;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 6px;
      color: #c62828;
    }

    form {
      margin-top: 10px;
      background: #ffe4ec;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    form h3 {
      color: #ad1457;
      margin-bottom: 10px;
    }

    form input {
      display: block;
      margin: 10px 0;
      width: 100%;
      padding: 8px;
      border: 1px solid #f48fb1;
      border-radius: 6px;
    }

    form button {
      margin-top: 10px;
      width: 100%;
    }
  </style>
</head>
<body>
  <header>Bienvenido al Panel de Control</header>

  <main>
    <div id="alertas"></div>

    <h2>‚ûï Registrar nuevo pr√©stamo</h2>
    <form id="formNuevoPrestamo">
      <input type="number" id="monto" placeholder="Monto del pr√©stamo (S/.)" required />
      <input type="number" id="interes" placeholder="Inter√©s (%)" required />
      <input type="number" id="cuotas" placeholder="N√∫mero de cuotas" required />
      <label for="fechaEmision"><strong>Fecha de emisi√≥n:</strong></label>
      <input type="date" id="fechaEmision" required />
      <button type="submit">Registrar pr√©stamo</button>
    </form>

    <h2>üë§ Informaci√≥n del Usuario</h2>
    <p><strong>Nombre:</strong> <span id="userNombre">Cargando...</span></p>
    <p><strong>Correo:</strong> <span id="userCorreo">Cargando...</span></p>

    <h2>üí∞ Tus Pr√©stamos y Cuotas</h2>
    <div id="prestamosContainer">
      <p>Cargando tus pr√©stamos...</p>
    </div>

    <div class="acciones">
      <button id="btnEnviarCorreo">üì© Enviar correo de prueba</button>
      <button id="btnLogout">üö™ Cerrar sesi√≥n</button>
    </div>
  </main>

  <footer>¬© 2025 Recordatorio Bancario</footer>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const API_URL = "https://demo-pmeu.onrender.com";
      const userData = JSON.parse(localStorage.getItem("usuario"));
      const prestamosContainer = document.getElementById("prestamosContainer");
      const alertas = document.getElementById("alertas");

      if (!userData) {
        window.location.href = "index.html";
        return;
      }

      document.getElementById("userNombre").textContent = userData.nombre;
      document.getElementById("userCorreo").textContent = userData.email;

      // üîπ Cargar pr√©stamos
      async function cargarPrestamos() {
        try {
          const res = await fetch(`${API_URL}/prestamos/usuario/${userData.id}`);
          const prestamos = await res.json();
          prestamosContainer.innerHTML = "";

          if (!prestamos.length) {
            prestamosContainer.innerHTML = `<p>No tienes pr√©stamos registrados.</p>`;
            return;
          }

          // detectar alertas de vencimiento
          let alertaMostrada = false;
          prestamos.forEach((p) => {
            const card = document.createElement("div");
            card.classList.add("prestamo-card");
            card.innerHTML = `
              <div class="prestamo-header">
                <h3>Pr√©stamo #${p.id}</h3>
                <span><strong>Monto:</strong> S/.${p.monto.toFixed(2)}</span>
              </div>
              <p><strong>Inter√©s:</strong> ${p.interes}% | <strong>Emitido:</strong> ${p.fechaEmision}</p>
              <div class="cuotas-list">
                ${p.cuotas
                  .map(
                    (c) => `
                  <div class="cuota-item">
                    <span>Cuota ${c.numero} - vence ${c.fechaVencimiento}</span>
                    <span class="estado ${c.estado.toLowerCase()}">${c.estado}</span>
                    ${
                      c.estado === "PENDIENTE"
                        ? `<button class="btnPagar" data-id="${c.id}">Pagar</button>`
                        : ""
                    }
                  </div>`
                  )
                  .join("")}
              </div>
            `;

            // toggle de cuotas
            const cuotasDiv = card.querySelector(".cuotas-list");
            card.addEventListener("click", (e) => {
              if (!e.target.classList.contains("btnPagar")) {
                cuotasDiv.style.display =
                  cuotasDiv.style.display === "block" ? "none" : "block";
              }
            });

            prestamosContainer.appendChild(card);

            // alertas por vencimiento cercano
            p.cuotas.forEach((c) => {
              const fechaV = new Date(c.fechaVencimiento);
              const hoy = new Date();
              const diff = (fechaV - hoy) / (1000 * 60 * 60 * 24);
              if (c.estado === "PENDIENTE" && diff <= 2 && diff >= 0 && !alertaMostrada) {
                alertas.innerHTML = `<div class="alerta">‚ö†Ô∏è Atenci√≥n: tienes cuotas que vencen en menos de 2 d√≠as.</div>`;
                alertaMostrada = true;
              }
            });
          });

          // listeners de pagar
          document.querySelectorAll(".btnPagar").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const cuotaId = btn.getAttribute("data-id");
              await fetch(`${API_URL}/cuotas/${cuotaId}/pagar`, { method: "PUT" });
              alert("‚úÖ Cuota marcada como pagada");
              cargarPrestamos();
            });
          });
        } catch (err) {
          prestamosContainer.innerHTML =
            "<p style='color:red;'>Error al cargar pr√©stamos.</p>";
          console.error(err);
        }
      }

      cargarPrestamos();

      // üîπ Registrar nuevo pr√©stamo
      document.getElementById("formNuevoPrestamo").addEventListener("submit", async (e) => {
        e.preventDefault();
        const monto = document.getElementById("monto").value;
        const interes = document.getElementById("interes").value;
        const numeroCuotas = document.getElementById("cuotas").value;
        const fechaEmision = document.getElementById("fechaEmision").value;

        if (!fechaEmision) {
          alert("‚ö†Ô∏è Debes seleccionar una fecha de emisi√≥n v√°lida");
          return;
        }

        await fetch(`${API_URL}/prestamos/crear?usuarioId=${userData.id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ monto, interes, numeroCuotas, fechaEmision }),
        });

        alert("‚úÖ Pr√©stamo registrado con √©xito");
        e.target.reset();
        cargarPrestamos();
      });

      // üîπ Enviar correo
      document.getElementById("btnEnviarCorreo").addEventListener("click", async () => {
        await fetch(`${API_URL}/email/test/usuario/${userData.id}`, { method: "POST" });
        alert("‚úÖ Correo de prueba enviado.");
      });

      // üîπ Logout
      document.getElementById("btnLogout").addEventListener("click", () => {
        localStorage.removeItem("usuario");
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
